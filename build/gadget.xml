<?xml version="1.0" encoding="utf-8"?>
<Module>
    <ModulePrefs title="Chess" author="Mic">
        <Require feature="wave" />
        <Require feature="dynamic-height" />
    </ModulePrefs>
    <Content type="html">
    <![CDATA[
        <!DOCTYPE html>
<html>
    <head>
        <style>
            * {
    padding: 0;
    margin: 0;
    font-size: 14px;
}

.icon {
    background: no-repeat url(data:image/png;base64,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);
}

.board {
    position: absolute;
    left: 0;
    top: 0;
}

.board .number {
    display: inline-block;
    width: 20px;
    height: 40px;
    text-align: center;
    vertical-align: top;
    line-height: 40px;
}

.board .letter {
    display: inline-block;
    width: 40px;
    height: 20px;
    text-align: center;
    line-height: 20px;
}

.board .row {
    height: 40px;
}

.board .cell {
    display: inline-block;
    width: 40px;
    height: 40px;
    position: relative;
}

.board .row:nth-child(even) .cell:nth-child(even),
.row:nth-child(odd) .cell:nth-child(odd) {
    background: #ffce9e;
}

.board .row:nth-child(even) .cell:nth-child(odd),
.row:nth-child(odd) .cell:nth-child(even) {
    background: #d18b47;
}

.board .piece,
.board .move,
.board .attack,
.board .en-passant,
.board .promotion,
.board .long-castling,
.board .short-castling {
    cursor: pointer;
}

.board .move,
.board .attack,
.board .en-passant,
.board .promotion,
.board .long-castling,
.board .short-castling {
    opacity: 0.5;
}

.board .move:hover,
.board .attack:hover,
.board .en-passant:hover,
.board .promotion:hover,
.board .long-castling:hover,
.board .short-castling:hover {
    opacity: 1;
}

.board .icon {
    position: absolute;
    left: 0;
    top: 0;
    width: 40px;
    height: 40px;
}

.board .white.pawn {
    background-position: 0 0; 
}

.board .white.knight {
    background-position: -40px 0; 
}

.board .white.rook {
    background-position: -80px 0; 
}

.board .white.bishop {
    background-position: -120px 0; 
}

.board .white.queen {
    background-position: -160px 0; 
}

.board .white.king {
    background-position: -200px 0; 
}

.board .black.pawn {
    background-position: 0 -40px; 
}

.board .black.knight {
    background-position: -40px -40px; 
}

.board .black.rook {
    background-position: -80px -40px; 
}

.board .black.bishop {
    background-position: -120px -40px; 
}

.board .black.queen {
    background-position: -160px -40px; 
}

.board .black.king {
    background-position: -200px -40px; 
}

.board .check {
    box-shadow: inset 0 0 20px 5px #b44eca;
}

.board .checkmate {
    box-shadow: inset 0 0 20px 5px #ca0000;
}

.board .stalemate {
    box-shadow: inset 0 0 20px 5px #555555;
}

.board .last-move {
    box-shadow: inset 0 0 20px 0 #4ecac1;
}

.board .chosen {
    box-shadow: inset 0 0 20px 5px #8bca4e;
}

.board .move {
    background-position: 0 -80px;
}

.board .attack {
    background-position: -40px -80px;
}

.board .en-passant,
.board .promotion,
.board .long-castling,
.board .short-castling {
    background-position: -80px -80px;
}

.board .rotate {
    width: 20px;
    height: 20px;
    border: 0;
    background: no-repeat center center url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH3QMVEhcVNe9vTwAAABl0RVh0Q29tbWVudABDcmVhdGVkIHdpdGggR0lNUFeBDhcAAAG4SURBVDjLlVO7qsJAFJyIsmmERND4QAtFREI6GwsbP8EfEGz8Aj9EsLAQwcYPEMFKFCQi+KiM2ihIisRGEgux2r3FJbk3ep8DW+xhZnbO2V0OT7Btmy0WC+i6jtvtBgAghCCZTCKTyUCWZQ4AdF1ng8EA3GfxZDJhm80GPyEcDkOWZUynUwD4MBiNRmy73eK/4ABgPB6z1WrlFgkhUBQF2WzWaQuqqsK27RcDv2VZrN1uu4VIJIJarcY9E7vdLmOMvRj4lsslKKWglCIQCKBSqXgIl8uFdTodZpqmy/u8fIZhuBtFUSAIgud0y7JACEEwGPzSwO84A0AqlXqJmMvlPIamabLH44Hz+fw+A0opnN54nv916tFo1GPokyTJjXM4HP59jX5JknA6nQAA6/X6V0G/32f7/R6CICCfz8NXLBbdBPf7Ha1Wi30nns/nTNM0UEpxvV5BCHl/SMPhkKmq6hJDoRDK5TLS6TREUeR2ux1TVdVN6nAajQbnDqTZbDLDMP7UN8/zqNfriMVinGeivV6PaZr2o1gURVSrVcTjcc7zmRwcj0c2m83w/LESiQQKhQJKpZJH8wbStuSOoyZmbAAAAABJRU5ErkJggg==);
    cursor: pointer;
}

.promotion-dialog {
    position: absolute;
    width: 160px;
    box-shadow: 0 0 20px 0 black;
    margin: 5px;
    z-index: 1;
}

.promotion-dialog .icon {
    position: static;
    float: left;
}

.promotion-dialog .icon:nth-child(odd){
    background-color: #ffce9e;
}

.promotion-dialog .icon:nth-child(even) {
    background-color: #d18b47;
}

.promotion-dialog .icon:hover{
    background-color: white;
}

.players {
    position: absolute;
    left: 350px;
    top: 0;
}

.players .player {
    display: inline-block;
    width: 40px;
    height: 245px;
    position: relative;
    vertical-align: -200px;
}

.players .player-icon {
    position: absolute;
    left: 0;
    top: 0;
    width: 40px;
    height: 40px;
}

.players .white .player-icon {
    background-position: -200px 0;
}

.players .black .player-icon {
    background-position: -200px -40px;
}

.players .player .avatar {
    position: absolute;
    left: 0;
    top: 40px;
    width: 40px;
    height: 40px;
    background: no-repeat center center #eeeeee;
    background-size: 40px;
}

.players .clock {
    display: none;
    position: absolute;
    left: -10px;
    top: 70px;
    width: 20px;
    height: 20px;
    background: no-repeat center center url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAQCAYAAAAvf+5AAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH3QMVEwsLKFVlRgAAABl0RVh0Q29tbWVudABDcmVhdGVkIHdpdGggR0lNUFeBDhcAAAE7SURBVCjPrZK9isJgEEVPzGrSBJtgpeAzCLapQzp9hfR5Bxu7NPoYAQUhbUjvOwRBSGHzYecP3G+LJe7a7cLeapg5zJ1hxlmv15Zf6EMSfwIXiwWe570V7/c7+/3+C7T2y9kYw3w+fwOPxyNd/WM8HnM+n6mqCs/z6Pf7ADyfT6qqAmAymdBL09QJwxBJlGWJ67q4rktZlkgiDEPSNHWczmaz2djL5cJwOATger0yGo3IsswB6HVgFEVIwhiDMQZJRFH0vXUXWGtfg//MdXp1rOsaSQRBQBAESKKu63cwz3Pbti2SiOOYOI6RRNu25HluAZztdmtPpxMAy+WSwWAAwOPxYLfbATCdTuk1TYMkkiTB932KoqAoCnzfJ0kSJNE0zfcJZ7MZvu+zWq1ec91uNw6HAwBOlmX/+z2f7xSbrUPYDNAAAAAASUVORK5CYII=);
}

.players .turn .clock {
    display: block;
}

.players .taken {
    position: absolute;
    left: 0;
    top: 85px;
    width: 40px;
    height: 160px;
}

.players .taken .icon {
    display: inline-block;
    width: 20px;
    height: 20px;
    background-size: 120px;
}

.players .taken .white.pawn {
    background-position: 0 0; 
}

.players .taken .white.knight {
    background-position: -20px 0; 
}

.players .taken .white.rook {
    background-position: -40px 0; 
}

.players .taken .white.bishop {
    background-position: -60px 0; 
}

.players .taken .white.queen {
    background-position: -80px 0; 
}

.players .taken .black.pawn {
    background-position: 0 -20px; 
}

.players .taken .black.knight {
    background-position: -20px -20px; 
}

.players .taken .black.rook {
    background-position: -40px -20px; 
}

.players .taken .black.bishop {
    background-position: -60px -20px; 
}

.players .taken .black.queen {
    background-position: -80px -20px; 
}

.hint {
    position: absolute;
    left: 350px;
    top: 250px;
    width: 150px;
}

        </style>
    </head>
    <body>
        <div class="board"></div>
        <div class="players">
            <div class="player white">
                <div class="icon player-icon"></div>
                <div class="avatar"></div>
                <div class="clock" title="Now moving"></div>
                <div class="taken" title="Taken pieces"></div>
            </div>
            VS 
            <div class="player black">
                <div class="icon player-icon"></div>
                <div class="avatar"></div>
                <div class="clock" title="Now moving"></div>
                <div class="taken" title="Taken pieces"></div>
            </div>
        </div>
        <div class="hint">
            <div class="player-hint"></div>
            <div class="piece-hint"></div>
        </div>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
        <script>
            (function() {
                var EventEmitter = function() {
    
};

EventEmitter.mixin = function(target) {
    var callbacks = {};
    target.on = function(event, callback) {
        if (!(event in callbacks)) {
            callbacks[event] = [];
        }
        callbacks[event].push(callback);
    };
    target.emit = function(event, getArguments) {
        if (!(event in callbacks)) {
            return;
        }
        var args = getArguments();
        if (!args) {
            return;
        }
        var handlers = callbacks[event];
        for (var i in handlers) {
            handlers[i].apply(null, args);
        }
    };
};

                var Piece = function(id, color) {
    this._id = id;
    this._color = color;
};

Piece.COLORS = {
    WHITE: 'white',
    BLACK: 'black'
};

Piece.TYPES = {
    PAWN: 'pawn',
    KNIGHT: 'knight',
    ROOK: 'rook',
    BISHOP: 'bishop',
    QUEEN: 'queen',
    KING: 'king'
};

Piece._getImplementationForType = function(type) {
    if (type == Piece.TYPES.PAWN) {
        return Pawn;
    }
    if (type == Piece.TYPES.KNIGHT) {
        return Knight;
    }
    if (type == Piece.TYPES.ROOK) {
        return Rook;
    }
    if (type == Piece.TYPES.BISHOP) {
        return Bishop;
    }
    if (type == Piece.TYPES.QUEEN) {
        return Queen;
    }
    if (type == Piece.TYPES.KING) {
        return King;
    }
};

Piece.get = function(color, type) {
    if (!Piece._id) {
        Piece._id = 0;
    }
    var implementation = Piece._getImplementationForType(type);
    var piece = new implementation(Piece._id, color);
    Piece._id += 1;
    return piece;
};

Piece.getInvertedColor = function(color) {
    return (color == Piece.COLORS.WHITE) ? Piece.COLORS.BLACK : Piece.COLORS.WHITE;
};

Piece.prototype.getId = function() {
    return this._id;
};

Piece.prototype.getColor = function() {
    return this._color;
};

Piece.prototype.getType = function() {
    throw new Error('not implemented');
};

Piece.prototype.iterateMoves = function(row, col, callback) {
    throw new Error('not implemented');
};

var Pawn = function() {
    Piece.apply(this, arguments);
};
Pawn.prototype = new Piece();

Pawn.prototype.getType = function() {
    return Piece.TYPES.PAWN;
};

Pawn.prototype.iterateMoves = function(row, col, callback) {
    if (this.getColor() == Piece.COLORS.WHITE) {
        callback(row - 1, col, 'move');
        if (row == 6) {
            callback(row - 2, col, 'move');
        }
        callback(row - 1, col - 1, 'attack');
        callback(row - 1, col + 1, 'attack');
    } else {
        callback(row + 1, col, 'move');
        if (row == 1) {
            callback(row + 2, col, 'move');
        }
        callback(row + 1, col - 1, 'attack');
        callback(row + 1, col + 1, 'attack');
    }
};

var Knight = function() {
    Piece.apply(this, arguments);
};
Knight.prototype = new Piece();

Knight.prototype.getType = function() {
    return Piece.TYPES.KNIGHT;
};

Knight.prototype.iterateMoves = function(row, col, callback) {
    var offsets = [[-2, -1], [-2, 1], [-1, -2], [-1, 2], [1, -2], [1, 2], [2, -1], [2, 1]];
    for (var i in offsets) {
        var offset = offsets[i];
        callback(row + offset[0], col + offset[1]);
    }
};

var Rook = function() {
    Piece.apply(this, arguments);
};
Rook.prototype = new Piece();

Rook.prototype.getType = function() {
    return Piece.TYPES.ROOK;
};

Rook.prototype.iterateMoves = function(row, col, callback) {
    for (var i = col - 1; i >= 0; i -= 1) {
        if (!callback(row, i)) {
            break;
        }
    }
    for (var i = col + 1; i < Board.SIZE; i += 1) {
        if (!callback(row, i)) {
            break;
        }
    }
    for (var i = row - 1; i >= 0; i -= 1) {
        if (!callback(i, col)) {
            break;
        }
    }
    for (var i = row + 1; i < Board.SIZE; i += 1) {
        if (!callback(i, col)) {
            break;
        }
    }
};

var Bishop = function() {
    Piece.apply(this, arguments);
};
Bishop.prototype = new Piece();

Bishop.prototype.getType = function() {
    return Piece.TYPES.BISHOP;
};

Bishop.prototype.iterateMoves = function(row, col, callback) {
    for (var i = row - 1, j = col - 1; i >= 0, j >= 0; i -= 1, j -= 1) {
        if (!callback(i, j)) {
            break;
        }
    }
    for (var i = row - 1, j = col + 1; i >= 0, j < Board.SIZE; i -= 1, j += 1) {
        if (!callback(i, j)) {
            break;
        }
    }
    for (var i = row + 1, j = col - 1; i < Board.SIZE, j >= 0; i += 1, j -= 1) {
        if (!callback(i, j)) {
            break;
        }
    }
    for (var i = row + 1, j = col + 1; i < Board.SIZE, j < Board.SIZE; i += 1, j += 1) {
        if (!callback(i, j)) {
            break;
        }
    }
};

var Queen = function() {
    Piece.apply(this, arguments);
};
Queen.prototype = new Piece();

Queen.prototype.getType = function() {
    return Piece.TYPES.QUEEN;
};

Queen.prototype.iterateMoves = function(row, col, callback) {
    for (var i = col - 1; i >= 0; i -= 1) {
        if (!callback(row, i)) {
            break;
        }
    }
    for (var i = col + 1; i < Board.SIZE; i += 1) {
        if (!callback(row, i)) {
            break;
        }
    }
    for (var i = row - 1; i >= 0; i -= 1) {
        if (!callback(i, col)) {
            break;
        }
    }
    for (var i = row + 1; i < Board.SIZE; i += 1) {
        if (!callback(i, col)) {
            break;
        }
    }
    for (var i = row - 1, j = col - 1; i >= 0, j >= 0; i -= 1, j -= 1) {
        if (!callback(i, j)) {
            break;
        }
    }
    for (var i = row - 1, j = col + 1; i >= 0, j < Board.SIZE; i -= 1, j += 1) {
        if (!callback(i, j)) {
            break;
        }
    }
    for (var i = row + 1, j = col - 1; i < Board.SIZE, j >= 0; i += 1, j -= 1) {
        if (!callback(i, j)) {
            break;
        }
    }
    for (var i = row + 1, j = col + 1; i < Board.SIZE, j < Board.SIZE; i += 1, j += 1) {
        if (!callback(i, j)) {
            break;
        }
    }
};

var King = function() {
    Piece.apply(this, arguments);
};
King.prototype = new Piece();

King.prototype.getType = function() {
    return Piece.TYPES.KING;
};

King.prototype.iterateMoves = function(row, col, callback) {
    var offsets = [[-1, -1], [-1, 0], [-1, 1], [0, -1], [0, 1], [1, -1], [1, 0], [1, 1]];
    for (var i in offsets) {
        var offset = offsets[i];
        callback(row + offset[0], col + offset[1]);
    }
};

                var PieceBuilder = function(color, board) {
    this._color = color;
    this._board = board;
};

PieceBuilder.prototype._createPiece = function(type, row, col) {
    var piece = Piece.get(this._color, type);
    this._board.placePiece(row, col, piece);
};

PieceBuilder.prototype._createPawns = function() {
    var row = this._color == Piece.COLORS.WHITE ? 6 : 1;
    for (var col = 0; col < 8; col += 1) {
        this._createPiece(Piece.TYPES.PAWN, row, col);
    }
};

PieceBuilder.prototype._createOtherPieces = function() {
    var row = this._color == Piece.COLORS.WHITE ? 7 : 0;
    this._createPiece(Piece.TYPES.ROOK, row, 0);
    this._createPiece(Piece.TYPES.KNIGHT, row, 1);
    this._createPiece(Piece.TYPES.BISHOP, row, 2);
    this._createPiece(Piece.TYPES.QUEEN, row, 3);
    this._createPiece(Piece.TYPES.KING, row, 4);
    this._createPiece(Piece.TYPES.BISHOP, row, 5);
    this._createPiece(Piece.TYPES.KNIGHT, row, 6);
    this._createPiece(Piece.TYPES.ROOK, row, 7);
};

PieceBuilder.prototype.build = function() {
    this._createPawns();
    this._createOtherPieces();
};

                var MoveSearch = function(board, piece, checksOnly) {
    this._board = board;
    this._piece = piece;
    this._checksOnly = checksOnly;
    this._moves = [];
};

MoveSearch.prototype._willBeCheck = function(row, col) {
    var changed = Board.getCopy(this._board);
    var piece = changed.getPieceByCoords(row, col);
    if (piece) {
        changed.removePiece(piece, true);
    }
    changed.movePiece(this._piece, row, col);
    var color = this._piece.getColor();
    return changed.isCheck(color);
};

MoveSearch.prototype._checkMove = function(row, col, extra) {
    if (!this._board.areCoordsCorrect(row, col)) {
        return false;
    }
    var piece = this._board.getPieceByCoords(row, col);
    if (!piece) {
        if (extra && extra != 'move') {
            return false;
        }
        if (!this._checksOnly && !this._willBeCheck(row, col)) {
            var move = {row: row, col: col, type: 'move'};
            this._moves.push(move);
        }
        return true;
    }
    if (piece.getColor() != this._piece.getColor()) {
        if (extra && extra != 'attack') {
            return false;
        }
        if (piece.getType() == Piece.TYPES.KING) {
            this._moves.push({row: row, col: col, type: 'check'});
            return false;
        }
        if (!this._checksOnly && !this._willBeCheck(row, col)) {
            var move = {row: row, col: col, type: 'attack'};
            this._moves.push(move);
        }
        return false;
    }
    return false;
};

MoveSearch.prototype._canEnPassant = function(fromRow, fromCol, toRow, toCol) {
    if (!this._board.areCoordsCorrect(toRow, toCol)) {
        return false;
    }
    var piece = this._board.getPieceByCoords(fromRow, toCol);
    if (!piece) {
        return false;
    }
    if (piece.getColor() == this._piece.getColor()) {
        return false;
    }
    if (piece.getType() != Piece.TYPES.PAWN) {
        return false;
    }
    var lastMove = this._board.getLastMove();
    if (!lastMove) {
        return false;
    }
    if (piece != lastMove.piece) {
        return false;
    }
    if (Math.abs(lastMove.row - fromRow) != 2) {
        return false;
    }
    if (this._willBeCheck(toRow, toCol)) {
        return false;
    }
    return true;
};

MoveSearch.prototype._checkForEnPassant = function(fromRow, fromCol, type) {
    var toRow = (this._piece.getColor() == Piece.COLORS.WHITE) ? fromRow - 1 : fromRow + 1;
    var toCol = (type == 'left') ? fromCol - 1 : fromCol + 1;
    if (this._canEnPassant(fromRow, fromCol, toRow, toCol)) {
        var move = {row: toRow, col: toCol, type: 'en-passant'}; 
        this._moves.push(move);
    }
};

MoveSearch.prototype._canPromotion = function(toRow, toCol) {
    var piece = this._board.getPieceByCoords(toRow, toCol);
    if (piece) {
        return false;
    }
    if (this._willBeCheck(toRow, toCol)) {
        return false;
    }
    return true;
};

MoveSearch.prototype._checkForPromotion = function(fromRow, fromCol) {
    var toRow = (this._piece.getColor() == Piece.COLORS.WHITE) ? 0 : 7;
    var toCol = fromCol;
    if (this._canPromotion(toRow, toCol)) {
        for (var i in this._moves) {
            var move = this._moves[i];
            if (move.row == toRow && move.col == toCol) {
                move.type = 'promotion';
                break;
            }
        }
    }
};

MoveSearch.prototype._addPawnExtraMoves = function() {
    var coords = this._board.getPieceCoords(this._piece);
    this._checkForEnPassant(coords.row, coords.col, 'left');
    this._checkForEnPassant(coords.row, coords.col, 'right');
    this._checkForPromotion(coords.row, coords.col);
};

MoveSearch.prototype._canCastling = function(row, col, length) {
    if (this._board.isMoved(this._piece)) {
        return null;
    }
    var corner = (length == 'long') ? 0 : 7;
    var piece = this._board.getPieceByCoords(row, corner);
    if (!piece) {
        return false;
    }
    var color = this._piece.getColor();
    if (piece.getColor() != color) {
        return false;
    }
    if (piece.getType() != Piece.TYPES.ROOK) {
        return false;
    }
    if (this._board.isMoved(piece)) {
        return false;
    }
    var step = (length == 'long') ? -1 : 1;
    for (var i = col + step; i != corner; i += step) {
        if (this._board.getPieceByCoords(row, i)) {
            return false;
        }
    }
    if (this._board.isCheck(color)) {
        return false;
    }
    for (var i = col + step, j = 0; j < 2; i += step, j += 1) {
        if (this._willBeCheck(row, i)) {
            return false;
        }
    }
    return true;
};

MoveSearch.prototype._checkForCastling = function(row, col, length) {
    if (this._canCastling(row, col, length)) {
        var col = (length == 'long') ? 2 : 6;
        var type = (length == 'long') ? 'long-castling' : 'short-castling';
        var move = {row: row, col: col, type: type};
        this._moves.push(move);
    }
};

MoveSearch.prototype._addKingExtraMoves = function() {
    var coords = this._board.getPieceCoords(this._piece);
    this._checkForCastling(coords.row, coords.col, 'long');
    this._checkForCastling(coords.row, coords.col, 'short');
};

MoveSearch.prototype._addExtraMoves = function() {
    var type = this._piece.getType();
    if (type == Piece.TYPES.PAWN) {
        this._addPawnExtraMoves();
    }
    if (type == Piece.TYPES.KING) {
        this._addKingExtraMoves();
    }
};

MoveSearch.prototype.get = function() {
    var coords = this._board.getPieceCoords(this._piece);
    this._piece.iterateMoves(coords.row, coords.col, $.proxy(this._checkMove, this));
    if (!this._checksOnly) {
        this._addExtraMoves();
    }
    return this._moves;
};

                var Player = function(id, name, avatar) {
    this._id = id;
    this._name = name;
    this._avatar = avatar;
};

Player.prototype.getId = function() {
    return this._id;
};

Player.prototype.getName = function() {
    return this._name;
};

Player.prototype.getAvatar = function() {
    return this._avatar;
};

                var Players = function(users) {
    EventEmitter.mixin(this);
    this._users = users;
    this._list = {};
    this._isLocked = false;
    this._color = null;
};

Players.prototype.set = function(color, id) {
    var info = this._users.get(id);
    var player = new Player(info.id, info.name, info.avatar);
    this._list[color] = player;
    this.emit('set', function() {
        return [color, player];
    });
};

Players.prototype.lock = function() {
    this._isLocked = true;
};

Players.prototype.checkForNewPlayer = function() {
    if (this._color in this._list) {
        return;
    }
    var info = this._users.getViewer();
    this.emit('new', $.proxy(function() {
        return [this._color, new Player(info.id, info.name, info.avatar)];
    }, this));
};

Players.prototype.canPlay = function(color) {
    if (this._isLocked) {
        return false;
    }
    if (color != this._color) {
        return false;
    }
    if (!(color in this._list)) {
        return true;
    }
    var player = this._list[color];
    var info = this._users.getViewer();
    if (player.getId() != info.id) {
        return false;
    }
    return true;
};

Players.prototype.turn = function() {
    this._color = (this._color == Piece.COLORS.WHITE) ? Piece.COLORS.BLACK : Piece.COLORS.WHITE;
    this._isLocked = false;
    this.emit('turn', $.proxy(function() {
        return [this._color];
    }, this));
};

                var PlayersView = function(board, players) {
    this._node = null;
    this._init(board, players);
};

PlayersView.prototype._onAttack = function(piece) {
    var color = piece.getColor();
    var type = piece.getType();
    var inverted = Piece.getInvertedColor(color);
    var container = this._node.find('.player.' + inverted + ' .taken');
    var node = $('<div class="icon ' + color + ' ' + type + '"></div>');
    container.append(node);
};

PlayersView.prototype._addBoardListeners = function(board) {
    board.on('attack', $.proxy(this._onAttack, this));
};

PlayersView.prototype._onSetPlayer = function(color, player) {
    var node = this._node.find('.player.' + color + ' .avatar');
    node.attr('title', player.getName());
    node.css('background-image', 'url(' + player.getAvatar() + ')');
};

PlayersView.prototype._onTurn = function(color) {
    this._node.find('.turn').removeClass('turn');
    var node = this._node.find('.player.' + color);
    node.addClass('turn');
};

PlayersView.prototype._addPlayersListeners = function(players) {
    players.on('set', $.proxy(this._onSetPlayer, this));
    players.on('turn', $.proxy(this._onTurn, this));
};

PlayersView.prototype._init = function(board, players) {
    this._node = $('.players');
    this._addBoardListeners(board);
    this._addPlayersListeners(players);
};

                var Board = function() {
    EventEmitter.mixin(this);
    this._field = null;
    this._pieces = null;
    this._moved = [];
    this._lastMove = null;
    this._createField();
};

Board.SIZE = 8;

Board.getCopy = function(board) {
    var copy = new Board();
    var pieces = board.getPieces();
    for (var i in pieces) {
        var info = pieces[i];
        copy.placePiece(info.row, info.col, info.piece);
    }
    return copy;
};

Board.prototype._createField = function() {
    this._field = [];
    for (var i = 0; i < Board.SIZE; i += 1) {
        var row = [];
        for (var j = 0; j < Board.SIZE; j += 1) {
            row.push(null);
        }
        this._field.push(row);
    }
    this._pieces = {};
};

Board.prototype.placePiece = function(row, col, piece) {
    this._field[row][col] = piece;
    var id = piece.getId();
    this._pieces[id] = {row: row, col: col, piece: piece};
    this.emit('place', function() {
        return [row, col, piece];
    });
};

Board.prototype.movePiece = function(piece, row, col) {
    var id = piece.getId();
    var info = this._pieces[id];
    this._field[row][col] = piece;
    this._field[info.row][info.col] = null;
    if (!this.isMoved(piece)) {
        this._moved.push(piece);
    }
    var lastMove = {piece: piece, row: info.row, col: info.col};
    this._lastMove = lastMove;
    info.row = row;
    info.col = col;
    this.emit('move', function() {
        return [lastMove.row, lastMove.col, row, col, piece];
    });
    var color = piece.getColor();
    var inverted = Piece.getInvertedColor(color);
    this.emit('check', $.proxy(function() {
        return this.isCheck(inverted) ? [inverted] : null;
    }, this));
    this.emit('checkmate', $.proxy(function() {
        return this.isCheckmate(inverted) ? [inverted] : null;
    }, this));
    this.emit('stalemate', $.proxy(function() {
        return this.isStalemate(inverted) ? [inverted] : null;
    }, this));
};

Board.prototype.removePiece = function(piece, isAttack) {
    var id = piece.getId();
    var info = this._pieces[id];
    this._field[info.row][info.col] = null;
    delete this._pieces[id];
    this.emit('remove', function() {
        return [info.row, info.col];
    });
    if (isAttack) {
        this.emit('attack', function() {
            return [piece];
        });
    }
};

Board.prototype.areCoordsCorrect = function(row, col) {
    if (!(row in this._field)) {
        return false;
    }
    if (!(col in this._field[row])) {
        return false;
    }
    return true;
};

Board.prototype.getPieces = function() {
    return this._pieces;
};

Board.prototype.getPiecesByColor = function(color) {
    var pieces = {};
    for (var i in this._pieces) {
        var info = this._pieces[i];
        var piece = info.piece;
        if (piece.getColor() == color) {
            var id = piece.getId();
            pieces[id] = info;
        }
    }
    return pieces;
};

Board.prototype.getPieceByCoords = function(row, col) {
    return this._field[row][col];
};

Board.prototype.getPieceByColorAndType = function(color, type) {
    var pieces = this.getPiecesByColor(color);
    for (var i in pieces) {
        var piece = pieces[i].piece;
        if (piece.getType() == type) {
            return piece;
        }
    }
    return null;
};

Board.prototype.getPieceCoords = function(piece) {
    var id = piece.getId();
    var info = this._pieces[id];
    return {row: info.row, col: info.col};
};

Board.prototype.isMoved = function(piece) {
    return $.inArray(piece, this._moved) != -1;
};

Board.prototype.getLastMove = function() {
    return this._lastMove;
};

Board.prototype.isCheck = function(color) {
    var inverted = Piece.getInvertedColor(color);
    var pieces = this.getPiecesByColor(inverted);
    for (var i in pieces) {
        var piece = pieces[i].piece;
        var search = new MoveSearch(this, piece, true);
        var moves = search.get();
        for (var j in moves) {
            if (moves[j].type == 'check') {
                return true;
            }
        }
    }
    return false;
};

Board.prototype._hasMoves = function(color) {
    var pieces = this.getPiecesByColor(color);
    for (var i in pieces) {
        var piece = pieces[i].piece;
        var search = new MoveSearch(this, piece);
        var moves = search.get();
        if (moves.length) {
            return true;
        }
    }
    return false;
};

Board.prototype.isCheckmate = function(color) {
    return this.isCheck(color) && !this._hasMoves(color);
};

Board.prototype.isStalemate = function(color) {
    return !this.isCheck(color) && !this._hasMoves(color);
};

                var BoardView = function(board) {
    EventEmitter.mixin(this);
    this._piece = null;
    this._node = null;
    this._board = board;
    this._isRotated = false;
    this._isFinished = false;
    this._init();
};

BoardView.CELL_SIZE = 40;

BoardView.prototype._createField = function() {
    this._node = $('.board');
    this._node.empty();
    for (var i = 0; i < Board.SIZE; i += 1) {
        var row = $('<div class="row"></div>');
        for (var j = 0; j < Board.SIZE; j += 1) {
            var cell = $('<div class="cell"></div>');
            row.append(cell);
        }
        var number = this._isRotated ? i + 1 : Board.SIZE - i;
        row.append('<div class="number">' + number + '</div>');
        this._node.append(row);
    }
    var row = $('<div></div>');
    for (var i = 0; i < Board.SIZE; i += 1) {
        var letter = String.fromCharCode(this._isRotated ? 104 - i : 97 + i);
        row.append('<div class="letter">' + letter + '</div>');
    }
    row.append('<button class="rotate" title="Rotate board"></button>');
    this._node.append(row);
};

BoardView.prototype._clearField = function(only) {
    if (!only || only == 'moves') {
        this._node.find('.move, .attack, .en-passant, .promotion, .long-castling, .short-castling').remove();
    }
    if (!only || only == 'pieces') {
        this._node.find('.chosen, .check, .checkmate, .stalemate').removeClass('chosen check checkmate stalemate');
    }
};

BoardView.prototype._getCoords = function(row, col) {
    if (this._isRotated) {
        row = Board.SIZE - row - 1;
        col = Board.SIZE - col - 1;
    }
    return {row: row, col: col};
};

BoardView.prototype._getCell = function(row, col) {
    var coords = this._getCoords(row, col);
    return this._node.find('.row:eq(' + coords.row + ') .cell:eq(' + coords.col + ')');
};

BoardView.prototype._placePiece = function(row, col, piece) {
    var cell = this._getCell(row, col);
    var node = $('<div class="icon piece ' + piece.getType() + ' ' + piece.getColor() + '"></div>');
    cell.append(node);
};

BoardView.prototype._removePiece = function(row, col) {
    var cell = this._getCell(row, col);
    cell.find('.piece').remove();
};

BoardView.prototype._onPlace = function(row, col, piece) {
    this._clearField();
    this._placePiece(row, col, piece);
};

BoardView.prototype._onMove = function(fromRow, fromCol, toRow, toCol, piece) {
    this._clearField();
    this._removePiece(fromRow, fromCol);
    this._node.find('.last-move').removeClass('last-move');
    var cell = this._getCell(fromRow, fromCol);
    cell.addClass('last-move');
    this._placePiece(toRow, toCol, piece);
    var cell = this._getCell(toRow, toCol);
    cell.addClass('last-move');
};

BoardView.prototype._onRemove = function(row, col) {
    this._clearField();
    this._removePiece(row, col);
};

BoardView.prototype._onCheck = function(color) {
    this._clearField();
    var piece = this._board.getPieceByColorAndType(color, Piece.TYPES.KING);
    var coords = this._board.getPieceCoords(piece);
    var cell = this._getCell(coords.row, coords.col);
    cell.addClass('check');
};

BoardView.prototype._onCheckmate = function(color) {
    this._clearField();
    var piece = this._board.getPieceByColorAndType(color, Piece.TYPES.KING);
    var coords = this._board.getPieceCoords(piece);
    var cell = this._getCell(coords.row, coords.col);
    cell.addClass('checkmate');
    this._isFinished = true;
};

BoardView.prototype._onStalemate = function(color) {
    this._clearField();
    var piece = this._board.getPieceByColorAndType(color, Piece.TYPES.KING);
    var coords = this._board.getPieceCoords(piece);
    var cell = this._getCell(coords.row, coords.col);
    cell.addClass('stalemate');
    this._isFinished = true;
};

BoardView.prototype._addBoardListeners = function() {
    this._board.on('place', $.proxy(this._onPlace, this));
    this._board.on('move', $.proxy(this._onMove, this));
    this._board.on('remove', $.proxy(this._onRemove, this));
    this._board.on('check', $.proxy(this._onCheck, this));
    this._board.on('checkmate', $.proxy(this._onCheckmate, this));
    this._board.on('stalemate', $.proxy(this._onStalemate, this));
};

BoardView.prototype._rotateBoard = function() {
    this._isRotated = !this._isRotated;
    this._createField();
    var pieces = this._board.getPieces();
    for (var i in pieces) {
        var info = pieces[i];
        this._placePiece(info.row, info.col, info.piece);
    }
};

BoardView.prototype._showAvailableMoves = function(row, col) {
    this._clearField('moves');
    var piece = this._board.getPieceByCoords(row, col);
    var search = new MoveSearch(this._board, piece);
    var moves = search.get();
    for (var i in moves) {
        var move = moves[i];
        var cell = this._getCell(move.row, move.col);
        var type = move.type;
        if (type != 'check') {
            var node = $('<div class="icon ' + type + '"></div>');
            cell.append(node);
        }
    }
};

BoardView.prototype._choosePiece = function(row, col) {
    this._node.find('.chosen').removeClass('chosen');
    var cell = this._getCell(row, col);
    cell.addClass('chosen');
    this._piece = {row: row, col: col};
    this._showAvailableMoves(row, col);
};

BoardView.prototype._showPromotionDialog = function(element, callback) {
    this._node.find('.promotion-dialog').remove();
    var piece = this._board.getPieceByCoords(this._piece.row, this._piece.col);
    var color = piece.getColor();
    var dialog = $(
        '<div class="promotion-dialog"> \
            <div class="icon piece ' + color + ' ' + Piece.TYPES.KNIGHT + '"></div> \
            <div class="icon piece ' + color + ' ' + Piece.TYPES.ROOK + '"></div> \
            <div class="icon piece ' + color + ' ' + Piece.TYPES.BISHOP + '"></div> \
            <div class="icon piece ' + color + ' ' + Piece.TYPES.QUEEN + '"></div> \
        </div>'
    );
    var offset = element.offset();
    dialog.offset(offset);
    dialog.click(function(event) {
        var element = $(event.target);
        if (element.hasClass('knight')) {
            callback(Piece.TYPES.KNIGHT);
        }
        if (element.hasClass('rook')) {
            callback(Piece.TYPES.ROOK);
        }
        if (element.hasClass('bishop')) {
            callback(Piece.TYPES.BISHOP);
        }
        if (element.hasClass('queen')) {
            callback(Piece.TYPES.QUEEN);
        }
        dialog.remove();
        return false;
    });
    this._node.append(dialog);
};

BoardView.prototype._addClickListener = function() {
    this._node.click($.proxy(function(event) {
        var offset = this._node.offset();
        var row = Math.floor((event.pageY - offset.top) / BoardView.CELL_SIZE);
        var col = Math.floor((event.pageX - offset.left) / BoardView.CELL_SIZE);
        var coords = this._getCoords(row, col);
        var element = $(event.target);
        if (element.hasClass('rotate')) {
            this._rotateBoard();
        }
        if (this._isFinished) {
            return false;
        }
        if (element.hasClass('piece')) {
            this._choosePiece(coords.row, coords.col);
        }
        if (!this._piece) {
            return false;
        }
        var piece = this._board.getPieceByCoords(this._piece.row, this._piece.col);
        if (element.hasClass('move')) {
            this.emit('move', function() {
                return [piece, coords.row, coords.col];
            });
        }
        if (element.hasClass('attack')) {
            this.emit('attack', function() {
                return [piece, coords.row, coords.col];
            });
        }
        if (element.hasClass('en-passant')) {
            this.emit('en-passant', function() {
                return [piece, coords.row, coords.col];
            });
        }
        if (element.hasClass('promotion')) {
            this._showPromotionDialog(element, $.proxy(function(replacement) {
                this.emit('promotion', function() {
                    return [piece, coords.row, coords.col, replacement];
                });
            }, this));
        }
        if (element.hasClass('long-castling')) {
            this.emit('castling', function() {
                return [piece, 'long'];
            });
        }
        if (element.hasClass('short-castling')) {
            this.emit('castling', function() {
                return [piece, 'short'];
            });
        }
        return false;
    }, this));    
};

BoardView.prototype._init = function() {
    this._createField();
    this._addBoardListeners();
    this._addClickListener();
};

                var HintView = function(board, players) {
    this._node = null;
    this._init(board, players);
};

HintView.prototype._set = function(section, text) {
    this._node.find('.' + section + '-hint').text(text);
};

HintView.prototype._clear = function(section) {
    this._set(section, '');
};

HintView.prototype._onMove = function() {
    this._clear('piece');
};

HintView.prototype._onCheck = function(color) {
    this._set('piece', 'Check to ' + color);
};

HintView.prototype._onCheckmate = function(color) {
    var inverted = Piece.getInvertedColor(color);
    this._set('piece', 'Checkmate to ' + color + ', ' + inverted + ' wins');
};

HintView.prototype._onStalemate = function(color) {
    this._set('piece', 'Stalemate to ' + color);
};

HintView.prototype._addBoardListeners = function(board) {
    board.on('move', $.proxy(this._onMove, this));
    board.on('check', $.proxy(this._onCheck, this));
    board.on('checkmate', $.proxy(this._onCheckmate, this));
    board.on('stalemate', $.proxy(this._onStalemate, this));
};

HintView.prototype._onPlayerSet = function(color) {
    if (color == Piece.COLORS.WHITE) {
        this._set('player', 'Move any black piece to join the game');
    }
    if (color == Piece.COLORS.BLACK) {
        this._clear('player');
    }
};

HintView.prototype._addPlayersListeners = function(players) {
    players.on('set', $.proxy(this._onPlayerSet, this));
};

HintView.prototype._init = function(board, players) {
    this._node = $('.hint');
    this._set('player', 'Move any white piece to join the game');
    this._addBoardListeners(board);
    this._addPlayersListeners(players);
};

                var Game = function(users) {
    EventEmitter.mixin(this);
    this._board = null;
    this._players = null;
    this._init(users);
};

Game.prototype._onMovePiece = function(piece, row, col) {
    if (!this._players.canPlay(piece.getColor())) {
        return;
    }
    this._players.lock();
    this._players.checkForNewPlayer();
    var coords = this._board.getPieceCoords(piece);
    this.emit('update', function() {
        return [{
            type: 'move',
            from: {row: coords.row, col: coords.col},
            to: {row: row, col: col}
        }];
    });
};

Game.prototype._onAttackPiece = function(piece, row, col) {
    if (!this._players.canPlay(piece.getColor())) {
        return;
    }
    this._players.lock();
    this._players.checkForNewPlayer();
    var coords = this._board.getPieceCoords(piece);
    this.emit('update', function() {
        return [{
            type: 'attack',
            from: {row: coords.row, col: coords.col},
            to: {row: row, col: col}
        }];
    });
};

Game.prototype._onEnPassant = function(piece, row, col) {
    if (!this._players.canPlay(piece.getColor())) {
        return;
    }
    this._players.lock();
    this._players.checkForNewPlayer();
    var coords = this._board.getPieceCoords(piece);
    this.emit('update', function() {
        return [{
            type: 'en-passant',
            from: {row: coords.row, col: coords.col},
            to: {row: row, col: col}
        }];
    });
};

Game.prototype._onPromotion = function(piece, row, col, replacement) {
    if (!this._players.canPlay(piece.getColor())) {
        return;
    }
    this._players.lock();
    this._players.checkForNewPlayer();
    var coords = this._board.getPieceCoords(piece);
    this.emit('update', function() {
        return [{
            type: 'promotion',
            from: {row: coords.row, col: coords.col},
            to: {row: row, col: col},
            replacement: replacement
        }];
    });
};

Game.prototype._onCastling = function(piece, length) {
    if (!this._players.canPlay(piece.getColor())) {
        return;
    }
    this._players.lock();
    this._players.checkForNewPlayer();
    this.emit('update', function() {
        return [{
            type: 'castling',
            color: piece.getColor(),
            length: length
        }];
    });
};

Game.prototype._initBoard = function() {
    this._board = new Board();
    var view = new BoardView(this._board);
    view.on('move', $.proxy(this._onMovePiece, this));
    view.on('attack', $.proxy(this._onAttackPiece, this));
    view.on('en-passant', $.proxy(this._onEnPassant, this));
    view.on('promotion', $.proxy(this._onPromotion, this));
    view.on('castling', $.proxy(this._onCastling, this));
    
};

Game.prototype._onNewPlayer = function(color, player) {
    this.emit('update', function() {
        return [{
            type: 'player',
            color: color,
            id: player.getId()}
        ];
    });
};

Game.prototype._initPlayers = function(users) {
    this._players = new Players(users);
    this._players.on('new', $.proxy(this._onNewPlayer, this));
    var view = new PlayersView(this._board, this._players);
    this._players.turn();
};

Game.prototype._initHint = function() {
    var view = new HintView(this._board, this._players);
};

Game.prototype._createPieces = function() {
    for (var i in Piece.COLORS) {
        var color = Piece.COLORS[i];
        var builder = new PieceBuilder(color, this._board);
        builder.build();
    }
};

Game.prototype._init = function(users) {
    this._initBoard();
    this._initPlayers(users);
    this._initHint();
    this._createPieces();
};

Game.prototype.update = function(update) {
    if (update.type == 'player') {
        this._players.set(update.color, update.id);
    }
    if (update.type == 'move') {
        var piece = this._board.getPieceByCoords(update.from.row, update.from.col);
        this._board.movePiece(piece, update.to.row, update.to.col);
        this._players.turn();
    }
    if (update.type == 'attack') {
        var victim = this._board.getPieceByCoords(update.to.row, update.to.col);
        this._board.removePiece(victim, true);
        var attacker = this._board.getPieceByCoords(update.from.row, update.from.col);
        this._board.movePiece(attacker, update.to.row, update.to.col);
        this._players.turn();
    }
    if (update.type == 'en-passant') {
        var victim = this._board.getPieceByCoords(update.from.row, update.to.col);
        this._board.removePiece(victim, true);
        var attacker = this._board.getPieceByCoords(update.from.row, update.from.col);
        this._board.movePiece(attacker, update.to.row, update.to.col);
        this._players.turn();
    }
    if (update.type == 'promotion') {
        var piece = this._board.getPieceByCoords(update.from.row, update.from.col);
        this._board.removePiece(piece);
        var replacement = Piece.get(piece.getColor(), update.replacement);
        this._board.placePiece(update.from.row, update.from.col, replacement);
        this._board.movePiece(replacement, update.to.row, update.to.col);
        this._players.turn();
    }
    if (update.type == 'castling') {
        var king = this._board.getPieceByColorAndType(update.color, Piece.TYPES.KING);
        var coords = this._board.getPieceCoords(king);
        var rook = this._board.getPieceByCoords(coords.row, update.length == 'long' ? 0 : 7);
        if (update.length == 'long') {
            this._board.movePiece(rook, coords.row, 3);
            this._board.movePiece(king, coords.row, 2);
        } else {
            this._board.movePiece(rook, coords.row, 5);
            this._board.movePiece(king, coords.row, 6);
        }
        this._players.turn();
    }
};

                var Users = function() {

};

Users.prototype._getInfo = function(user) {
    return {
        id: user.getId(),
        name: user.getDisplayName(),
        avatar: user.getThumbnailUrl()
    };
};

Users.prototype.get = function(id) {
    var user = wave.getParticipantById(id);
    return this._getInfo(user);
};

Users.prototype.getViewer = function() {
    var viewer = wave.getViewer();
    return this._getInfo(viewer); 
};

                var Gadget = function() {
    this._revision = 0;
    this._game = null;
    this._updates = [];
    this._init();
};

Gadget.prototype._onGameUpdate = function(update) {
    this._updates.push(update);
    if (this._updates.length > 1) {
        return;
    }
    setTimeout($.proxy(function() {
        var state = wave.getState();
        var revision = state.get('revision') || 0;
        var delta = {};
        for (var i in this._updates) {
            var update = this._updates[i];
            revision += 1;
            delta['update-' + revision] = gadgets.json.stringify(update);
        }
        delta.revision = revision;
        state.submitDelta(delta);
        this._updates = [];
    }, this), 0);
};

Gadget.prototype._onStateUpdate = function() {
    var state = wave.getState();
    var revision = state.get('revision');
    if (!revision) {
        return;
    }
    for (var i = this._revision + 1; i <= revision; i += 1) {
        var update = gadgets.json.parse(state.get('update-' + i));
        this._game.update(update);
    }
    this._revision = revision;
};

Gadget.prototype._init = function() {
    gadgets.util.registerOnLoadHandler($.proxy(function() {
        if (!wave || !wave.isInWaveContainer()) {
            return;
        }
        this._game = new Game(new Users());
        this._game.on('update', $.proxy(this._onGameUpdate, this));
        gadgets.window.adjustHeight();
        wave.setStateCallback($.proxy(this._onStateUpdate, this));
    }, this));
};

                var gadget = new Gadget();
            })();
        </script>
    </body>
</html>

    ]]>
    </Content>
</Module>
